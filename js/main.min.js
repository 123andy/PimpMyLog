/*global numeral,logs_refresh_default,logs_max_default,files,notification_title,badges,lemma,geoip_url,pull_to_refresh,csrf_token,user_time_zone,notification_default*/var file,notification,auto_refresh_timer,fingerprint,first_launch,file_size,last_line,loading,reset,notification_displayed,set_auto_refresh=function(e){$("#autorefresh").val(e)},set_max=function(e){$("#max").val(e)},notification_class="warning",set_notification=function(e){e===undefined&&(e=notification);if(e===!0){$("#notification").removeClass("btn-warning btn-success btn-danger").addClass("active btn-"+notification_class);notification=!0}else{$("#notification").removeClass("btn-warning btn-success btn-danger active");notification=!1}},is_notification=function(){return $("#notification").hasClass("active")},notify=function(e,t){if("webkitNotifications"in window){var n=window.webkitNotifications.checkPermission();if(n===0){notification_class="success";set_notification();if(notification===!0&&e!==undefined&&notification_displayed===!1){notification_displayed=!0;var r=window.webkitNotifications.createNotification("img/icon_072.png",e,t);r.onclick=function(){window.focus();r.close()};r.onclose=function(){notification_displayed=!1};r.show();setTimeout(function(){try{r.close()}catch(e){}},5e3)}}else if(n===2){notification_class="danger";set_notification()}else{notification_class="warning";set_notification();window.webkitNotifications.requestPermission(function(){notify(e,t)})}}else if("Notification"in window)if(window.Notification.permission==="default"){notification_class="warning";set_notification();window.Notification.requestPermission(function(){notify(e,t)})}else if(window.Notification.permission==="granted"){notification_class="success";set_notification();if(notification===!0&&e!==undefined&&notification_displayed===!1){notification_displayed=!0;var i=new window.Notification(e,{body:t,tag:"Pimp My Log"});i.onclick=function(){this.close()};i.onclose=function(){notification_displayed=!1}}}else if(window.Notification.permission==="denied"){notification_class="danger";set_notification();return}},pml_alert=function(e,t){$('<div class="alert alert-'+t+' alert-dismissable fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+e+"</div>").appendTo("#notice")},pml_singlealert=function(e,t){$("#singlenotice").html('<div class="alert alert-'+t+' alert-dismissable fade in"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+e+"</div>")},type_parser=function(e){var t="txt",n="",r=0;if(e!==undefined){var i=e.split("/");if(i[1]!==undefined){r=parseInt(e.split("/").slice(-1),10);t=e.split("/").slice(0,-1).join("/")}else t=e;i=t.split(":");if(i[1]!==undefined){n=t.split(":").slice(1).join(":");t=i[0]}}return{parser:t,param:n,cut:r}},val_cut=function(e,t){return t===undefined?e:t===0?e:e.length<=Math.abs(t)?e:t>0?e.substr(0,t)+"&hellip;":"&hellip;"+e.substr(t)},get_logs=function(load_default_values,load_full_file){var wanted_lines;if(auto_refresh_timer!==null){clearTimeout(auto_refresh_timer);auto_refresh_timer=null}if(load_default_values===!0){set_max(files[file].max);set_auto_refresh(files[file].refresh);set_notification(files[file].notify);load_full_file=!0}else load_default_values=!1;if(load_full_file===!0){reset=1;file_size=0;last_line=""}else{reset=0;load_full_file=!1}$(".loader").toggle();loading=!0;wanted_lines=$("#max").val();$.ajax({url:"inc/getlog.pml.php?"+user_time_zone+(new Date).getTime(),data:{ldv:load_default_values,file:file,filesize:file_size,max:wanted_lines,search:$("#search").val(),csrf_token:csrf_token,lastline:last_line,reset:reset},type:"POST",dataType:"json"}).fail(function(e){$(".loader").toggle();loading=!1;if(e.error){$("#result").hide();$("#error").show();$("#errortxt").html(e.responseText);notify(notification_title.replace(/%f/g,files[file].display),lemma.error);return}}).done(function(logs){$(".loader").toggle();loading=!1;file_size=logs.newfilesize;last_line=logs.lastline;if(logs.error){$("#result").hide();$("#error").show();$("#errortxt").html(logs.error);notify(notification_title.replace(/%f/g,files[file].display),lemma.error);return}logs.warning&&pml_alert(logs.warning,"warning");logs.notice&&pml_alert(logs.notice,"info");logs.singlewarning&&pml_singlealert(logs.singlewarning,"warning");logs.singlenotice&&pml_singlealert(logs.singlenotice,"info");$("#error").hide();$("#result").show();if(logs.full)if(logs.found===!1){var nolog=lemma.no_log;logs.search!==""&&(logs.regsearch?nolog=lemma.search_no_regex.replace("%s","<code>"+logs.search+"</code>"):nolog=lemma.search_no_regular.replace("%s","<code>"+logs.search+"</code>"));$("#nolog").html(nolog).show();$("#logshead").hide()}else{$("#nolog").text("").hide();$("#logshead").show()}else if(logs.logs){$("#nolog").text("").hide();$("#logshead").show()}if(logs.regsearch){$("#searchctn").addClass("has-success");$("#searchctn").prop("title",lemma.regex_valid)}else{$("#searchctn").removeClass("has-success");$("#searchctn").prop("title",lemma.regex_invalid)}if(logs.headers){$("#logshead").text("");var sort="Date",sortsc="down";for(var h in logs.headers){var s=sort===h?'<span class="glyphicon glyphicon-chevron-'+sortsc+'"/></span>':"";$("<th>"+logs.headers[h]+s+"</th>").addClass(h).appendTo("#logshead")}}logs.full&&$("#logsbody").text("");$("#logsbody tr").removeClass("newlog");var uaparser=new UAParser,rowidx=0,rows=[];for(var log in logs.logs){var tr=$("<tr>").addClass("file");for(var c in logs.logs[log]){if("pml"===c)continue;var type=type_parser(files[file].format.types[c]),val=logs.logs[log][c],title=val;val==="-"&&(val="");if("badge"===type.parser){var clas;type.param==="http"?clas=badges[type.param][logs.logs[log][c].substr(0,1)]:type.param==="severity"?clas=badges[type.param][logs.logs[log][c]]:clas="default";val='<span class="label label-'+clas+'">'+val_cut(val,type.cut)+"</span>"}else if("date"===type.parser){title=logs.logs[log].pml;val=val_cut(val,type.cut)}else if("numeral"===type.parser)val!==""&&type.param!==""&&(val=numeral(val).format(type.param));else if("ip"===type.parser)type.param==="geo"?val='<a href="'+geoip_url.replace("%p",val)+'" target="linkout">'+val_cut(val,type.cut)+"</a>":val='<a href="'+type.param+"://"+val+'" target="linkout">'+val_cut(val,type.cut)+"</a>";else if("link"===type.parser)val='<a href="'+val+'" target="linkout">'+val_cut(val,type.cut)+"</a>";else if("ua"===type.parser){var ua=uaparser.setUA(val).getResult(),uas=type.param.match(/\{[a-zA-Z.]*\}/g),uaf=!1;for(var k in uas){var a;try{a=eval("ua."+uas[k].replace("{","").replace("}",""));a===undefined&&(a="")}catch(e){a=""}if(a!==""){uaf=!0;type.param=type.param.replace(uas[k],a)}}uaf===!0&&(val=$.trim(type.param))}else val=val_cut(val,type.cut);$("<td>"+val+"</td>").prop("title",title).addClass("pml-"+c+" pml-"+type.parser).appendTo(tr)}if(!logs.full){tr.addClass("newlog");rowidx++}rows.push(tr)}if(logs.full)$("#logsbody").append(rows);else{$("#logsbody").prepend(rows);var rowd=$("#logsbody tr").length;if(rowd>wanted_lines){rowd-=wanted_lines;$("#logsbody").find("tr:nth-last-child(-n+"+rowd+")").remove()}}var rowct="",rowc=$("#logsbody tr").length;rowc===1?rowct=lemma.display_log+" ":rowc>1&&(rowct=lemma.display_nlogs.replace("%s",rowc)+" ");$("#footer").html(rowct+logs.footer);if(first_launch===!1)if(logs.full){if(logs.fingerprint!==fingerprint){notify(notification_title.replace(/%f/g,files[file].display),lemma.new_logs);fingerprint=logs.fingerprint}}else rowidx===1?notify(notification_title.replace(/%f/g,files[file].display),lemma.new_log):rowidx>1&&notify(notification_title.replace(/%f/g,files[file].display),lemma.new_nlogs.replace("%s",rowidx));first_launch=!1;var i=Math.max(0,parseInt($("#autorefresh").val(),10));i>0&&(auto_refresh_timer=setTimeout(function(){get_logs()},i*1e3))}).always(function(){})};$(function(){function e(e){return e?"addClass":"removeClass"}$("#file_selector").text($(".file_menu:first").text());$(".file_menu:first").parent().addClass("active");file=$(".file_menu:first").parent().data("file");$(".file_menu").click(function(){$("#file_selector").text($(this).text());$(".file_menu").parent().removeClass("active");$(this).parent().addClass("active");file=$(this).parent().data("file");get_logs(!0)});$(".logo").click(function(){location.reload()});$("#refresh").click(function(){notify();get_logs()});$(document).keypress("r",function(e){if($(e.target).is("input, textarea"))return;notify();get_logs()});$(document).on("input",".clearable",function(){$(this)[e(this.value)]("x")}).on("mousemove",".x",function(t){$(this)[e(this.offsetWidth-18<t.clientX-this.getBoundingClientRect().left)]("onX")}).on("click",".onX",function(){$(this).removeClass("x onX").val("")});$("#search").blur(function(){get_logs(!1,!0)});$(document).keydown(function(e){if(e.keyCode===13){if($("#search").is(":focus")){$("#search").blur();get_logs(!1,!0)}e.preventDefault();return!1}});set_auto_refresh(logs_refresh_default);$("#autorefresh").change(function(){get_logs()});set_max(logs_max_default);$("#max").change(function(){get_logs(!1,!0)});$.ajax({url:"inc/upgrade.pml.php?"+(new Date).getTime(),dataType:"json",data:{csrf_token:csrf_token},type:"POST"}).done(function(e){$("#upgradefooter").html(" - "+e.footer);var t=$.cookie("upgrade"+e.to);if(t!=="hide"){$("#upgrademessage").html(e.alert);$("#upgradestop").click(function(){$.cookie("upgrade"+$(this).data("version"),"hide");$("#upgradealert").alert("close")})}});if("Notification"in window||"webkitNotifications"in window){$("#notification").show();set_notification(notification_default)}$("#notification").click(function(){$(this).hasClass("btn-warning")?notify():$(this).hasClass("btn-danger")?pml_alert(lemma.notification_deny,"danger"):set_notification(!is_notification())});notify();pull_to_refresh===!0&&$("#hook").hook({dynamic:!1,reloadPage:!1,reloadEl:function(){notify();get_logs()}});get_logs(!0)});